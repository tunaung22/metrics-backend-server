@page "/Reports/Submissions/Key-Kpi/{periodName}/View"
@using Metrics.Application.Domains
@using Metrics.Infrastructure.Services
@using Microsoft.EntityFrameworkCore.Metadata.Internal
@model Metrics.Web.Pages.Reports.Submissions.KeyKpi.ViewModel
@{
    ViewData["Title"] = "Department Key KPI Detail Report";
    @* var ALL_DEPARTMENT = Group.Equals("all", StringComparison.OrdinalIgnoreCase); *@
}


<div class="sectionTitle">
    <div class="d-flex align-items-center my-2">
        <span class="d-flex align-items-center flex-grow-1">
            <h4><i class="bi bi-table"></i> Key KPI Detail Report for Period @Model.SelectedPeriodName</h4>
            <span class="mx-4">
                Period: <strong>@Model.SelectedPeriod.PeriodName</strong>
                <small>(@Model.SelectedPeriod.SubmissionStartDate.ToString("MMM dd, yyyy") - @Model.SelectedPeriod.SubmissionEndDate.ToString("MMM dd, yyyy"))</small>
            </span>
        </span>
        <span class="justify-content-end gap-2">
        </span>
    </div>

    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-page="/Dashboard/Index">Dashboard</a></li>
            <li class="breadcrumb-item"><a asp-page="/Reports/Submissions/Index">Reports</a></li>
            <li class="breadcrumb-item"><a asp-page="/Reports/Submissions/DepartmentKeyKpi/Index">Department Key KPI</a></li>
            <li class="breadcrumb-item active">View</li>
        </ol>
    </nav>
</div>

<div class="filter-toolbar mb-4 px-4 d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-2">
        <form id="form__groupSelection" method="get" class="">
            <span class="d-flex align-items-center">
                @* <div class="col-auto me-2">
                    <label for="ViewMode" class="form-label m-0">
                        <i class="bi bi-collection-fill"></i> View Mode</label>
                </div> *@
                @* <div class="col-auto me-4">
                    <select 
                        asp-for="ViewMode"
                        asp-items="Model.ReportViewModeListItems"
                        onchange="this.form.submit()"
                        class="form-select"
                        aria-label="Select View Mode">
                    </select>
                </div> *@

                <div class="col-auto me-2">
                    <label asp-for="Group" class="form-label m-0">
                        <i class="bi bi-people-fill"></i> Group</label>
                </div>
                <div class="col-auto me-4">
                    <select 
                        asp-for="Group"
                        asp-items="Model.UserGroupListItems"
                        onchange="this.form.submit()"
                        class="form-select"
                        aria-label="Select User Group">
                    </select>
                </div>

                <div class="col-auto me-2">
                    <label asp-for="Department" class="form-label m-0">
                        <i class="bi bi-filter"></i> Candiate Department:</label>
                </div>
                <div class="col-auto me-4">
                    <select 
                        asp-for="Department"
                        asp-items="Model.SubmitterDepartmentListItems"
                        onchange="this.form.submit()"
                        class="form-select"
                        aria-label="Select Department">
                    </select>
                </div>
            </span>
        </form>
        @* <button>Button</button> *@
    </div>

    <div class="exportData">
        <form method="post" asp-page-handler="ExportExcel">
                    @* <input type="hidden" asp-for="ViewMode"> *@
                    <input type="hidden" asp-for="Group">
                    <input type="hidden" asp-for="Department">
            @* 
                **use single handler: ExportExcel
                for all four models?
            *@
            @if(Model.KeyKpi_DetailReportList.Any())
            {
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-file-earmark-spreadsheet"></i> Export</button>
            }
            else
            {
                <button type="submit" 
                    class="btn btn-success disabled">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export</button>
            }
        </form>
    </div>
</div>

<div class="container-fluid">
    <div class="bg-light p-4 rounded-2">

        <div asp-validation-summary="ModelOnly" class="alert alert-danger text-danger" role="alert"></div>

        <div class="table-responsive">
            @* =============ALL GROUP============================================ *@
            @if (Model.Group.Equals("all", StringComparison.OrdinalIgnoreCase))
            {
                @if(Model.KeyKpi_DetailReportList.Any())
                {
                    <table id="allUserGroupDetailTable" class="allUserGroupDetailTable table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th colspan="4" data-dt-order="disable">Candidate</th>
                                <th colspan="2">Key Metrics</th>
                                <th rowspan="2">Score</th>
                                <th rowspan="2">Comments</th>
                            </tr>
                            <tr>
                                <th>Candidate ID</th>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Group</th>
                                <th>Issue Department</th>
                                <th>Key</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach(var user in Model.SubmitterList) // loop all submitters
                            {
                                // filter/find submissions by User
                                if(Model.KeyKpi_DetailReportList.Any())
                                {
                                    var submissionsByUser = Model.KeyKpi_DetailReportList
                                        .Where(s => s.SubmittedBy.Id == user.Id)
                                        .ToList();

                                    foreach(var entry in submissionsByUser)
                                    {
                                        if (entry.KeyKpi_DetailReportItems != null && entry.KeyKpi_DetailReportItems.Count > 0)
                                        { 
                                            var itemCount = entry.KeyKpi_DetailReportItems.Count;
                                            @* var isFirstRow = true; *@
                                            foreach(var item in entry.KeyKpi_DetailReportItems)
                                            {
                                                var submitterTextColor = "";
                                                var submissionTextColor = item.ScoreValue>0.00M ? "" : "text-secondary";
                                                <tr>
                                                    <td class="@submitterTextColor">@entry.SubmittedBy.UserCode</td>
                                                    <td class="@submitterTextColor">@entry.SubmittedBy.FullName</td>
                                                    <td class="@submitterTextColor">@entry.SubmittedBy.Department.DepartmentName</td>
                                                    <td class="@submitterTextColor">@entry.SubmittedBy.UserGroup.GroupName</td>

                                                    <td class="@submissionTextColor">@item.DepartmentKeyMetric.KeyIssueDepartment.DepartmentName</td>
                                                    <td class="@submissionTextColor">@item.DepartmentKeyMetric.KeyMetric.MetricTitle</td>
                                                    <td class="@submissionTextColor">@item.ScoreValue.ToString("0.00")</td>
                                                    <td class="@submissionTextColor">
                                                        @if(!string.IsNullOrEmpty(@item.Comments)) {
                                                            @if(@item.Comments.Length > 25) 
                                                            {
                                                                var comments = @item.Comments.Substring(0, 25) + "...";
                                                                @comments <button data-details="@item.Comments" data-label="Positive Aspects" class="moreButton_positiveAspects btn btn-link p-0 pb-2">More</button>
                                                            }
                                                            else
                                                            { 
                                                                @item.Comments 
                                                            }
                                                        }
                                                        else 
                                                        { 
                                                            @:None 
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    }
                                }
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <!-- For the Candidate column -->
                                <th></th> @* candidate id *@
                                <th></th> @* candidate name *@
                                <th></th> @* candidate department *@ 
                                <th></th> @* candidate group *@
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                }
                else
                {
                    <p class="alert alert-danger text-danger text-center">No Data</p>
                }
            }
            
            @* =============SINGLE GROUP===== *@
            else {
                @if(Model.KeyKpi_DetailReportList.Any())
                {
                    <table id="allUserGroupDetailTable" class="allUserGroupDetailTable table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th colspan="4" data-dt-order="disable">Candidate</th>
                                <th colspan="2">Key Metrics</th>
                                <th rowspan="2">Score</th>
                                <th rowspan="2">Comments</th>
                            </tr>
                            <tr>
                                <th>Candidate ID</th>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Group</th>
                                <th>Issue Department</th>
                                <th>Key</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach(var user in Model.SubmitterList) // loop all submitters
                            {
                                // filter/find submissions by User
                                if(Model.KeyKpi_DetailReportList.Any())
                                {
                                    var submissionsByUser = Model.KeyKpi_DetailReportList
                                        .Where(s => s.SubmittedBy.Id == user.Id)
                                        .ToList();
                                    @foreach(var entry in submissionsByUser)
                                    {
                                        @if (entry.KeyKpi_DetailReportItems != null && entry.KeyKpi_DetailReportItems.Count > 0)
                                        { 
                                            var itemCount = entry.KeyKpi_DetailReportItems.Count;
                                            @* var isFirstRow = true; *@

                                            @foreach(var item in entry.KeyKpi_DetailReportItems)
                                            {
                                                var submitterTextColor = "";
                                                var submissionTextColor = item.ScoreValue>0.00M ? "" : "text-secondary";
                                                <tr>
                                                    <td class="@submitterTextColor">@entry.SubmittedBy.UserCode</td>
                                                    <td class="@submitterTextColor">@entry.SubmittedBy.FullName</td>
                                                    <td class="@submitterTextColor">@entry.SubmittedBy.Department.DepartmentName</td>
                                                    <td class="@submitterTextColor">@entry.SubmittedBy.UserGroup.GroupName</td>

                                                    <td class="@submissionTextColor">@item.DepartmentKeyMetric.KeyIssueDepartment.DepartmentName</td>
                                                    <td class="@submissionTextColor">@item.DepartmentKeyMetric.KeyMetric.MetricTitle</td>
                                                    <td class="@submissionTextColor">@item.ScoreValue.ToString("0.00")</td>
                                                    <td class="@submissionTextColor">
                                                        @if(@item.Comments != null && @item.Comments.Any()) {
                                                            var comments = @item.Comments.Substring(0, 25) + "...";
                                                            @if(@item.Comments.Length > 25) 
                                                            {
                                                                @comments
                                                                <button data-details="@item.Comments" data-label="Positive Aspects"
                                                                        class="moreButton_positiveAspects btn btn-link p-0 pb-2">More</button>
                                                            }
                                                            else 
                                                            {
                                                                @item.Comments
                                                            }
                                                        }
                                                        else 
                                                        {
                                                            @:None
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    }
                                }
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <!-- For the Candidate column -->
                                <th></th> @* candidate id *@
                                <th></th> @* candidate name *@
                                <th></th> @* candidate department *@ 
                                <th></th> @* candidate group *@
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                }
                else
                {
                    <p class="alert alert-danger text-danger text-center">No Data</p>
                }
            }
        </div>
    </div>
</div>


<!--Modal Dialog -->
<div id="dialog_textDetail" class="modal modal-xl fade" tabindex="-1" aria-labelledby="dialogTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dialogTitle"><i class="bi bi-info-circle"></i> Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row bg-light submitter-info"> @* ===== submitter's info ===== *@
                    <div class="col">
                        <label class="" for="">Name</label>
                        <p id="dSubmitterName"></p>
                    </div>
                    <div class="col">
                        <label class="" for="">Department</label>
                        <p id="dSubmitterDepartment"></p>
                    </div>
                    <div class="col">
                        <label class="" for="">Contact Phone</label>
                        <p id="dSubmitterPhone"></p>
                    </div>
                </div>
                <div class="row bg-light case-department-info"> @* ===== case department info===== *@
                    <div class="col-12 col-sm-6 col-md-4">
                        <label class="" for="">Case Department</label>
                        <p id="dCaseDepartmentName"></p>
                    </div>
                    <div class="col-12 col-sm-6 col-md-auto">
                        <label class="" for="">Given Score</label>
                        <p id="dGivenScore"></p>
                    </div>
                </div>
                <div class="row mb-3 bg-light patient-info"> @* ===== patient info===== *@
                    <div class="col">
                        <div class="row mb-4">
                            <div class="col-12 col-sm-6 col-md-4">
                                <label class="" for="">Ward Name</label>
                                <p id="dWardName"></p>
                            </div>
                            <div class="col-12 col-sm-6 col-md-auto">
                                <label class="" for="">Incident At</label>
                                <p id="dIncidentAt"></p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label class="" for="">Patient Name</label>
                                <p id="dPatientName"></p>
                            </div>
                            <div class="col">
                                <label class="" for="">CPI Number</label>
                                <p id="dCPINumber"></p>
                            </div>
                            <div class="col">
                                <label class="" for="">Room Number</label>
                                <p id="dRoomNumber"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3 bg-light description-and-suggestions"> @* ===== description & suggestions===== *@
                    <div class="col">
                        <label class="" for="">Description</label>
                        <p id="dCaseDescription" class="longText"></p>
                    </div>
                    <div class="col">
                        <label class="" for="">Suggestion</label>
                        <p id="dCaseSuggestion" class="longText"></p>
                    </div>
                </div>
                @* <p id="dContent"></p> *@
            </div>
             <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        #dialog_textDetail > div  p {
            min-height: 2em;
            margin: 0;
            padding: .2em .2em;
            font-weight: 600;
        }
        #dialog_textDetail > div  p.longText {
            min-height: 5em;
        }
        .modal-body > .row {
            margin: 1.4em 1.4em;
            padding: 1em 1em;
        }
        .submitter-info p {
            color: var(--metric-green-color);
        }
        .case-department-info p {
            color: var(--metric-red-color);
        }
        .patient-info p {
            color: var(--metric-blue-color);
        }
        .description-and-suggestions p {
            color: var(--metric-blue-color);
        }
    </style>
}

@section Scripts {
    <script>
        @* $(function() { *@
        $(document).ready(function() {
            // ------------------- DATATABLE -----------------------------------
            if($("#allUserGroupSummaryTable").length) {
                new DataTable('#allUserGroupSummaryTable', {
                    paging: true,
                    pageLength: 50,
                    info: true,
                    searching: false,
                    autoWidth: true,
                    scroller: true,
                    scrollY: 600,
                    columnDefs: [
                        { width: '16%', targets: 0 },
                        { sortable: false, targets: ['.no-sort'] },
                        @* { orderable: false, targets: noSortTargets } // Disable sorting for specified columns *@
                    ],
                    initComplete: function() {
                        $('.dataTable thead th').addClass('text-light text-center align-middle');
                        $('.dataTable thead th').addClass('bg-brand-color');
                        $('.dataTable tfoot th').addClass('bg-brand-color text-light');
                        @* $('#allUserGroupSummaryTable thead th').addClass('text-light text-center align-middle');
                        $('#allUserGroupSummaryTable thead th').addClass('bg-brand-color'); *@
                    }
                });
            }
            else if($("#singleUserGroupSummaryTable").length) {
                new DataTable('#singleUserGroupSummaryTable', {
                    paging: true,
                    pageLength: 50,
                    info: true,
                    searching: false,
                    autoWidth: true,
                    scroller: true,
                    scrollY: 600,
                    columnDefs: [
                        { width: '16%', targets: 0 },
                        { sortable: false, targets: ['.no-sort'] },
                        @* { orderable: false, targets: noSortTargets } // Disable sorting for specified columns *@
                    ],
                    initComplete: function() {
                        $('.dataTable thead th').addClass('text-light text-center align-middle');
                        $('.dataTable thead th').addClass('bg-brand-color');
                        $('.dataTable tfoot th').addClass('bg-brand-color text-light');
                        @* $('#singleUserGroupSummaryTable thead th').addClass('text-light text-center align-middle');
                        $('#singleUserGroupSummaryTable thead th').addClass('bg-brand-color'); *@
                    }
                });
            }
            else if($("#allUserGroupDetailTable").length) {
                new DataTable('#allUserGroupDetailTable', {
                    paging: false,
                    pageLength: 50,
                    info: false,
                    searching: false,
                    autoWidth: true,
                    scroller: false,
                    scrollY: 600,
                    columnDefs: [
                        @* { width: '16%', targets: 0 }, *@
                        { sortable: false, targets: ['.no-sort', 0] },
                    ],
                    initComplete: function() {
                        $('.allUserGroupDetailTable thead th').addClass('text-light text-center align-middle');
                        $('.allUserGroupDetailTable thead th').addClass('bg-brand-color');
                        $('.allUserGroupDetailTable tfoot th').addClass('bg-brand-color text-light');

                        // for keyTitle
                        $('.allUserGroupDetailTable thead th.keyTitle').removeClass('align-middle');
                        $('.allUserGroupDetailTable thead th.keyTitle').addClass('align-top');
                    },
                  
                });
            }
            else if($("#singleUserGroupDetailTable").length) {
                new DataTable('#singleUserGroupDetailTable', {
                    paging: true,
                    pageLength: 50,
                    info: true,
                    searching: false,
                    autoWidth: true,
                    @* fixedHeader: true, *@
                    @* fixedHeader: {
                        header: true,
                        footer: true
                    }, *@
                    scroller: true,
                    scrollY: 600,
                    columnDefs: [
                        { width: '16%', targets: 0 },
                        { sortable: false, targets: ['.no-sort'] },
                        @* { orderable: false, targets: noSortTargets } // Disable sorting for specified columns *@
                    ],
                    initComplete: function() {
                        $('.dataTable thead th').addClass('text-light text-center align-middle');
                        $('.dataTable thead th').addClass('bg-brand-color');
                        $('.dataTable tfoot th').addClass('bg-brand-color text-light');
                        @* $('#singleUserGroupDetailTable thead th').addClass('text-light text-center align-middle');
                        $('#singleUserGroupDetailTable thead th').addClass('bg-brand-color');
                        $('#singleUserGroupDetailTable tfoot th').addClass('bg-brand-color text-light'); *@
                    },
                    footerCallback: function (row, data, start, end, display) {
                        let api = this.api();
                
                        @foreach(var department in Model.KeyIssueDepartmentList)
                        {
                            //  0      1          2              3
                            // ID, Candidate, Department, Admin Department,...
                            var index = Model.KeyIssueDepartmentList.IndexOf(department) + 3; // +1 for Candidate is column 0
                            <text>
                            // Calculate total for @department.DepartmentName (column @index)
                            var total_@(index) = api
                                .column(@index)
                                .data()
                                .reduce(function (a, b) {
                                    return parseFloat(a) + parseFloat(b);
                                }, 0);
                            
                            // Update footer
                            @* $(api.column(@index).footer()).html(
                                'Total: ' + total_@(index).toFixed(2)
                            ); *@
                            $(api.column(@index).footer()).html(total_@(index).toFixed(2));
                            </text>
                        }
                    }
                });
            }
        });
    </script>
}
