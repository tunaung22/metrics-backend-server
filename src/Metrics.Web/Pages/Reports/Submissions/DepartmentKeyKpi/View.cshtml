@page "/Reports/Submissions/Department-Key-Kpi/{periodName}"
@using Metrics.Application.Domains
@using Metrics.Infrastructure.Services
@using Microsoft.EntityFrameworkCore.Metadata.Internal
@model Metrics.Web.Pages.Reports.Submissions.DepartmentKeyKpi.ViewModel
@{
    ViewData["Title"] = "Department Key KPI Report";
}


<div class="sectionTitle">
    <div class="d-flex align-items-center my-2">
        <span class="d-flex align-items-center flex-grow-1">
            <h4>Department Key KPI Report</h4>
            <span class="mx-4">
                Period: <strong>@Model.SelectedPeriod.PeriodName</strong>
                <small>(@Model.SelectedPeriod.SubmissionStartDate.ToString("MMM dd, yyyy") - @Model.SelectedPeriod.SubmissionEndDate.ToString("MMM dd, yyyy"))</small>
            </span>
        </span>
        <span class="justify-content-end gap-2">
        </span>
    </div>

    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-page="/Dashboard/Index">Dashboard</a></li>
            <li class="breadcrumb-item"><a asp-page="/Reports/Submissions/Index">Reports</a></li>
            <li class="breadcrumb-item"><a asp-page="/Reports/Submissions/DepartmentKeyKpi/Index">Department Key KPI</a></li>
            <li class="breadcrumb-item active">View</li>
        </ol>
    </nav>
</div>

<div class="filter-toolbar mb-4 px-4 d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-2">
        <form id="form__groupSelection" method="get" class="">
            <span class="d-flex align-items-center">
                <div class="col-auto me-2">
                    <label for="ViewMode" class="form-label m-0">
                        <i class="bi bi-collection-fill"></i> View Mode</label>
                </div>
                <div class="col-auto me-4">
                    <select 
                        asp-for="ViewMode"
                        asp-items="Model.ReportViewModeListItems"
                        onchange="this.form.submit()"
                        class="form-select"
                        aria-label="Select View Mode">
                    </select>
                </div>

                <div class="col-auto me-2">
                    <label for="Group" class="form-label m-0">
                        <i class="bi bi-people-fill"></i> User Group</label>
                </div>
                <div class="col-auto me-4">
                    <select 
                        asp-for="Group"
                        asp-items="Model.UserGroupListItems"
                        onchange="this.form.submit()"
                        class="form-select"
                        aria-label="Select User Group">
                    </select>
                </div>
            </span>
        </form>
        @* <button>Button</button> *@
    </div>

    <div class="exportData">
        <form method="post" asp-page-handler="ExportExcel">
                    <input type="hidden" asp-for="ViewMode">
                    <input type="hidden" asp-for="Group">
            @* 
                **use single handler: ExportExcel
                for all four models?
            *@
            @if(Model.AllUserGroup_SummaryList.Any()
                || Model.AllUserGroup_DetailList.Any()
                || Model.SingleUserGroup_SummaryList.Any()
                || Model.SingleUserGroup_DetailList.Any())
            {
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-file-earmark-spreadsheet"></i> Export</button>
            }
            else
            {
                <button type="submit" 
                    class="btn btn-success disabled">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export</button>
            }
        </form>
    </div>
</div>

<div class="container-fluid">
    <div class="bg-light p-4 rounded-2">

        <div asp-validation-summary="ModelOnly" class="alert alert-danger text-danger" role="alert"></div>

        <div class="table-responsive">
        @if(!string.IsNullOrEmpty(Model.ViewMode) && !string.IsNullOrEmpty(Model.Group) ) {
                    
@* ==================SUMMARY VIEW======================================================================== *@
                    if (Model.ViewMode.Equals("summary", StringComparison.OrdinalIgnoreCase))
                    {
                        @* =====ALL GROUP + SUMMARY============================= *@
                        @* department, [group]+subm+scr, ..., totalSubm, totalScr, kpi *@
                        if(Model.AllUserGroup_SummaryList.Any())
                        {
                            // to get consistent User Group List
                            @* var userGroupSubmissions = Model.AllUserGroup_SummaryList
                                .SelectMany(s => s.UserGroupSubmissions ?? [])
                                .DistinctBy(s=>s.GroupName)
                                .ToList() ?? []; *@
                            <table id="allUserGroupSummaryTable" class="table table-bordered table-striped">
                            <thead> <!-- department, group+submission+score, totalSubmission, totalScore, KPI-->
                                <tr>
                                    <th rowspan="2">Departments</th>

                                    @* @foreach(var group in userGroupSubmissions) {
                                        <th colspan="2">Group: @group.GroupName</th>
                                    } *@

                                    <th rowspan="2">Total Submissions</th>
                                    <th rowspan="2">Total Scores</th>
                                    <th rowspan="2">KPI Score</th>
                                </tr>
                                <tr>
                                    @* @foreach(var group in userGroupSubmissions) {
                                        <th>Submissions</th>
                                        <th>Scores</th>
                                    } *@
                                </tr>
                            </thead>
                            <tbody>
                                @foreach(var submission in Model.AllUserGroup_SummaryList)
                                {
                                    <tr>
                                        <td>@submission.DepartmentName</td>
                                        
                                        
                                        @* @foreach(var groupSubmission in submission.UserGroupSubmissions)
                                        {
                                            <td>@groupSubmission.TotalSubmissions.ToString("0")</td>
                                            <td>@groupSubmission.TotalScore.ToString("0.00")</td>
                                        } *@

                                        <td>@submission.TotalSubmissions.ToString("0")</td>
                                        <td>@submission.TotalScore.ToString("0.00")</td>
                                        <td>
                                            <strong>
                                                @submission.KpiScore.ToString("0.00")
                                            </strong>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            </table>
                        }
                        @* =====SINGLE GROUP + SUMMARY========================== *@
                        @* department, totalSubm, totalScr, kpi *@
                        else if(Model.SingleUserGroup_SummaryList.Any())
                        {
                            <table id="singleUserGroupSummaryTable" class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Departments</th>
                                    <th>Submissions</th>
                                    <th>Scores</th>
                                    <th>KPI Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach(var submission in Model.SingleUserGroup_SummaryList)
                                {
                                    <tr>
                                        @* <td>@submission.DepartmentName</td> *@
                                        @* <td>@submission.TotalSubmissions.ToString("0")</td>
                                        <td>@submission.TotalScore.ToString("0.00")</td>
                                        <td>@submission.KpiScore.ToString("0.00")</td> *@
                                    </tr>
                                }
                            </tbody>
                            </table>
                        }
                        else
                        {
                            <p class="alert alert-danger text-danger text-center">No Data</p>
                        }
                    }

@* =============DETAIL VIEW======================================================================== *@
                    else if (Model.ViewMode.Equals("detail", StringComparison.OrdinalIgnoreCase))
                    {
@* ============= ALL GROUP + DETAIL ===== *@
                        @* submitter, [department score], ..., score, totalScr *@
                        if (Model.Group.Equals("all", StringComparison.OrdinalIgnoreCase))
                        {
                            @if(Model.AllUserGroup_DetailList.Any())
                            {
                                <table id="allUserGroupDetailTable" class="allUserGroupDetailTable table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th colspan="4" rowspan="2" 
                                            class="fs-3 fw-bold"
                                            data-dt-order="disable">Candidate</th>

                                        @foreach(var department in Model.DepartmentList)
                                        {
                                            @* var noOfKeys = Model.AllUserGroup_DetailList
                                                .DistinctBy(i=> i.KeyKpi_DepartmentScoreDetails)
                                                .SelectMany(i=> i.KeyKpi_DepartmentScoreDetails)
                                                .Where(detail => 
                                                    string.Equals(detail.DepartmentName,department.DepartmentName, StringComparison.OrdinalIgnoreCase))
                                                .ToList().Count; *@
                                            var noOfKeys = Model.DepartmentKeyMetrics
                                                .Where(dkm => dkm.DepartmentId == department.Id)
                                                .Count();
                                            
                                            <th colspan="@(noOfKeys > 0 ? noOfKeys*2 : 2)"
                                                data-dt-order="disable">@department.DepartmentName @noOfKeys</th>
                                            @* @for(int i= 0; i<noOfKeys; i++) {
                                                <th colspan="2" class="text-center">@department.DepartmentName @noOfKeys</th>
                                            } *@
                                        }
                                    </tr>
                                    <tr>
                                        @foreach(var department in Model.DepartmentList)
                                        {
                                            @* var keyItems = Model.AllUserGroup_DetailList
                                                .SelectMany(i=> i.KeyKpi_DepartmentScoreDetails)
                                                .Where(detail => 
                                                    string.Equals(detail.DepartmentName, department.DepartmentName, StringComparison.OrdinalIgnoreCase))
                                                .ToList(); *@
                                            var keyItems = Model.DepartmentKeyMetrics
                                                .Where(dkm => dkm.DepartmentId == department.Id)
                                                .ToList();

                                            foreach(var key in keyItems)
                                            {
                                                <th colspan="2" class="keyTitle mono-text" data-dt-order="disable">
                                                    <div class="text-warning">@department.DepartmentName</div>
                                                    <div>@key.KeyMetric.MetricTitle</div>
                                                </th>
                                            }
                                        }
                                    </tr>
                                    <tr>
                                        <th>Candidate ID</th>
                                        <th>Name</th>
                                        <th>Department</th>
                                        <th>Group</th>

                                        @foreach(var department in Model.DepartmentList)
                                        {
                                            @* var keyItems = Model.AllUserGroup_DetailList
                                                .SelectMany(i=> i.KeyKpi_DepartmentScoreDetails)
                                                .Where(detail => 
                                                    string.Equals(detail.DepartmentName, department.DepartmentName, StringComparison.OrdinalIgnoreCase))
                                                .ToList(); *@
                                            var keyItems = Model.DepartmentKeyMetrics
                                                .Where(dkm => dkm.DepartmentId == department.Id)
                                                .ToList();

                                            foreach(var key in keyItems)
                                            {
                                                <th>Score</th>
                                                <th>Comments</th>
                                            }
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach(var entry in Model.AllUserGroup_DetailList) 
                                    {
                                        <tr>
                                            <td>@entry.SubmittedBy.UserCode</td>
                                            <td>@entry.SubmittedBy.FullName</td>
                                            <td>@entry.SubmittedBy.Department.DepartmentName</td>
                                            <td>@entry.SubmittedBy.UserGroup.GroupName</td>

                                            @if (entry.KeyKpi_DepartmentScoreDetails!=null && 
                                                entry.KeyKpi_DepartmentScoreDetails.Count >0)
                                            {
                                                @foreach(var item in entry.KeyKpi_DepartmentScoreDetails)
                                                {
                                                    <td>@item.ScoreValue.ToString("0.00")</td>
                                                    <td>
                                                        @if(@item.Comments != null && @item.Comments.Any()) {
                                                            @if(@item.Comments.Length > 50) {
                                                                @(@item.Comments.Substring(0, 50) + "...")
                                                                <button data-details="@item.Comments" data-label="Positive Aspects"
                                                                        class="moreButton_positiveAspects btn btn-link p-0 pb-2">More</button>
                                                            }
                                                            else {
                                                                @item.Comments
                                                            }
                                                        }
                                                        else {
                                                            @:None
                                                        }
                                                    </td>
                                                }
                                            }
                                            else
                                            {
                                                <td>-1.00</td>
                                                <td>-</td>
                                            }
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <!-- For the Candidate column -->
                                        <th></th> @* candidate id *@
                                        <th></th> @* candidate name *@
                                        <th></th> @* candidate department *@ 
                                        <th></th> @* candidate group *@

                                        @{
                                            var flattenedDepartmentDetails = Model.AllUserGroup_DetailList
                                                .SelectMany(e=>e.KeyKpi_DepartmentScoreDetails).ToList();
                                        }
                                        
                                        @foreach(var department in Model.DepartmentList)
                                        {
                                            // Filter DKMs by Department
                                            var DKMs = Model.DepartmentKeyMetrics
                                                .Where(dkm => dkm.DepartmentId == department.Id)
                                                .ToList();

                                            foreach(var dkm in DKMs)
                                            {
                                                // for each DKM, get Sum of Score from all Details(of department)
                                                var totalScore = flattenedDepartmentDetails
                                                    .Where(d=> d.DKMId == dkm.Id)
                                                    .OrderBy(d=> d.KeyId)
                                                    .Sum(d=>d.ScoreValue);

                                                <th>@totalScore.ToString("0.00")</th>
                                                <th></th>
                                            }
                                        }
                                    </tr>
                                </tfoot>
                                </table>
                            }
                        }
                        else {
@* ============= SINGLE GROUP + DETAIL ===== *@
                            @* ???submitter, [department score], ..., score, totalScr *@
                            if(Model.SingleUserGroup_DetailList.Any())
                            {
                                <table id="singleUserGroupDetailTable" class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th colspan="3">Candidate</th>
                                        @foreach(var department in Model.DepartmentList)
                                        {
                                            <th>@department.DepartmentName</th>
                                        }
                                    </tr>
                                    <tr>
                                        <th>Candidate ID</th>
                                        <th>Name</th>
                                        <th>Department</th>
                                        @foreach(var department in Model.DepartmentList)
                                        {
                                            <th>Score</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach(var entry in Model.SingleUserGroup_DetailList) 
                                    {
                                        <tr>
                                            <td>@entry.SubmittedBy.UserCode</td>
                                            <td>@entry.SubmittedBy.FullName</td>
                                            <td>@entry.SubmittedBy.Department.DepartmentName</td>
                                            @* <td>@(entry.GroupName != null ? entry.GroupName.ToUpper() : "N/A")</td> *@
                                            @foreach(var d in Model.DepartmentList)
                                            {
                                                // if Department == DepartmentScores.Department
                                                // **likely contains only 1 if exist
                                                var item = entry.KeyKpi_DepartmentScoreSummary
                                                    .Where(dc => 
                                                        dc.DepartmentName!= null && dc.DepartmentName.Equals(d.DepartmentName, StringComparison.OrdinalIgnoreCase))
                                                    .FirstOrDefault();
                                                if (item != null)
                                                {
                                                    <td>@item.TotalScore.ToString("0.00")</td>
                                                }
                                                else {
                                                    <td>@(0M.ToString("0.00"))</td>
                                                }
                                            }
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th></th>
                                        <th></th> <!-- For the Candidate column -->
                                        <th></th>
                                        @foreach(var department in Model.DepartmentList)
                                        {
                                            <th></th> <!-- Empty cells that will be filled by footerCallback -->
                                        }
                                    </tr>
                                </tfoot>
                                </table>
                            }
                            else
                            {
                                <p class="alert alert-danger text-danger text-center">No Data</p>
                            }
                        }
                    }
                    else
                    {
                        <p>No such View Mode</p>
                    }
                }
        </div>
    </div>
</div>


<!--Modal Dialog -->
<div id="dialog_textDetail" class="modal modal-xl fade" tabindex="-1" aria-labelledby="dialogTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dialogTitle"><i class="bi bi-info-circle"></i> Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row bg-light submitter-info"> @* ===== submitter's info ===== *@
                    <div class="col">
                        <label class="" for="">Name</label>
                        <p id="dSubmitterName"></p>
                    </div>
                    <div class="col">
                        <label class="" for="">Department</label>
                        <p id="dSubmitterDepartment"></p>
                    </div>
                    <div class="col">
                        <label class="" for="">Contact Phone</label>
                        <p id="dSubmitterPhone"></p>
                    </div>
                </div>
                <div class="row bg-light case-department-info"> @* ===== case department info===== *@
                    <div class="col-12 col-sm-6 col-md-4">
                        <label class="" for="">Case Department</label>
                        <p id="dCaseDepartmentName"></p>
                    </div>
                    <div class="col-12 col-sm-6 col-md-auto">
                        <label class="" for="">Given Score</label>
                        <p id="dGivenScore"></p>
                    </div>
                </div>
                <div class="row mb-3 bg-light patient-info"> @* ===== patient info===== *@
                    <div class="col">
                        <div class="row mb-4">
                            <div class="col-12 col-sm-6 col-md-4">
                                <label class="" for="">Ward Name</label>
                                <p id="dWardName"></p>
                            </div>
                            <div class="col-12 col-sm-6 col-md-auto">
                                <label class="" for="">Incident At</label>
                                <p id="dIncidentAt"></p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label class="" for="">Patient Name</label>
                                <p id="dPatientName"></p>
                            </div>
                            <div class="col">
                                <label class="" for="">CPI Number</label>
                                <p id="dCPINumber"></p>
                            </div>
                            <div class="col">
                                <label class="" for="">Room Number</label>
                                <p id="dRoomNumber"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3 bg-light description-and-suggestions"> @* ===== description & suggestions===== *@
                    <div class="col">
                        <label class="" for="">Description</label>
                        <p id="dCaseDescription" class="longText"></p>
                    </div>
                    <div class="col">
                        <label class="" for="">Suggestion</label>
                        <p id="dCaseSuggestion" class="longText"></p>
                    </div>
                </div>
                @* <p id="dContent"></p> *@
            </div>
             <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        #dialog_textDetail > div  p {
            min-height: 2em;
            margin: 0;
            padding: .2em .2em;
            font-weight: 600;
        }
        #dialog_textDetail > div  p.longText {
            min-height: 5em;
        }
        .modal-body > .row {
            margin: 1.4em 1.4em;
            padding: 1em 1em;
        }
        .submitter-info p {
            color: var(--metric-green-color);
        }
        .case-department-info p {
            color: var(--metric-red-color);
        }
        .patient-info p {
            color: var(--metric-blue-color);
        }
        .description-and-suggestions p {
            color: var(--metric-blue-color);
        }
    </style>
}

@section Scripts {
    <script>
        @* $(function() { *@
        $(document).ready(function() {
            // ------------------- DATATABLE -----------------------------------
            if($("#allUserGroupSummaryTable").length) {
                new DataTable('#allUserGroupSummaryTable', {
                    paging: true,
                    pageLength: 50,
                    info: true,
                    searching: false,
                    autoWidth: true,
                    scroller: true,
                    scrollY: 600,
                    columnDefs: [
                        { width: '16%', targets: 0 },
                        { sortable: false, targets: ['.no-sort'] },
                        @* { orderable: false, targets: noSortTargets } // Disable sorting for specified columns *@
                    ],
                    initComplete: function() {
                        $('.dataTable thead th').addClass('text-light text-center align-middle');
                        $('.dataTable thead th').addClass('bg-brand-color');
                        $('.dataTable tfoot th').addClass('bg-brand-color text-light');
                        @* $('#allUserGroupSummaryTable thead th').addClass('text-light text-center align-middle');
                        $('#allUserGroupSummaryTable thead th').addClass('bg-brand-color'); *@
                    }
                });
            }
            else if($("#singleUserGroupSummaryTable").length) {
                new DataTable('#singleUserGroupSummaryTable', {
                    paging: true,
                    pageLength: 50,
                    info: true,
                    searching: false,
                    autoWidth: true,
                    scroller: true,
                    scrollY: 600,
                    columnDefs: [
                        { width: '16%', targets: 0 },
                        { sortable: false, targets: ['.no-sort'] },
                        @* { orderable: false, targets: noSortTargets } // Disable sorting for specified columns *@
                    ],
                    initComplete: function() {
                        $('.dataTable thead th').addClass('text-light text-center align-middle');
                        $('.dataTable thead th').addClass('bg-brand-color');
                        $('.dataTable tfoot th').addClass('bg-brand-color text-light');
                        @* $('#singleUserGroupSummaryTable thead th').addClass('text-light text-center align-middle');
                        $('#singleUserGroupSummaryTable thead th').addClass('bg-brand-color'); *@
                    }
                });
            }
            else if($("#allUserGroupDetailTable").length) {
                new DataTable('#allUserGroupDetailTable', {
                    paging: false,
                    pageLength: 50,
                    info: false,
                    searching: false,
                    autoWidth: true,
                    scroller: false,
                    scrollY: 600,
                    initComplete: function() {
                        $('.allUserGroupDetailTable thead th').addClass('text-light text-center align-middle');
                        $('.allUserGroupDetailTable thead th').addClass('bg-brand-color');
                        $('.allUserGroupDetailTable tfoot th').addClass('bg-brand-color text-light');

                        // for keyTitle
                        $('.allUserGroupDetailTable thead th.keyTitle').removeClass('align-middle');
                        $('.allUserGroupDetailTable thead th.keyTitle').addClass('align-top');
                    },
                  
                });
            }
            else if($("#singleUserGroupDetailTable").length) {
                new DataTable('#singleUserGroupDetailTable', {
                    paging: true,
                    pageLength: 50,
                    info: true,
                    searching: false,
                    autoWidth: true,
                    @* fixedHeader: true, *@
                    @* fixedHeader: {
                        header: true,
                        footer: true
                    }, *@
                    scroller: true,
                    scrollY: 600,
                    columnDefs: [
                        { width: '16%', targets: 0 },
                        { sortable: false, targets: ['.no-sort'] },
                        @* { orderable: false, targets: noSortTargets } // Disable sorting for specified columns *@
                    ],
                    initComplete: function() {
                        $('.dataTable thead th').addClass('text-light text-center align-middle');
                        $('.dataTable thead th').addClass('bg-brand-color');
                        $('.dataTable tfoot th').addClass('bg-brand-color text-light');
                        @* $('#singleUserGroupDetailTable thead th').addClass('text-light text-center align-middle');
                        $('#singleUserGroupDetailTable thead th').addClass('bg-brand-color');
                        $('#singleUserGroupDetailTable tfoot th').addClass('bg-brand-color text-light'); *@
                    },
                    footerCallback: function (row, data, start, end, display) {
                        let api = this.api();
                
                        @foreach(var department in Model.DepartmentList)
                        {
                            //  0      1          2              3
                            // ID, Candidate, Department, Admin Department,...
                            var index = Model.DepartmentList.IndexOf(department) + 3; // +1 for Candidate is column 0
                            <text>
                            // Calculate total for @department.DepartmentName (column @index)
                            var total_@(index) = api
                                .column(@index)
                                .data()
                                .reduce(function (a, b) {
                                    return parseFloat(a) + parseFloat(b);
                                }, 0);
                            
                            // Update footer
                            @* $(api.column(@index).footer()).html(
                                'Total: ' + total_@(index).toFixed(2)
                            ); *@
                            $(api.column(@index).footer()).html(total_@(index).toFixed(2));
                            </text>
                        }
                    }
                });
            }
        });
    </script>
}
